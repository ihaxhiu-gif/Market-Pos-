<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8">
<title>Market POS PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Quagga Camera Scanner -->
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
header{background:#020617;color:#fff;padding:14px}
nav button{margin:4px;padding:10px 14px;border-radius:10px;border:none;background:#1e293b;color:#fff}
section{display:none;padding:14px}
section.active{display:block}
.card{background:#fff;padding:14px;border-radius:16px;margin-bottom:14px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
input,button{padding:10px;border-radius:10px;border:1px solid #cbd5e1;font-size:16px}
button{border:none;font-weight:600}
.primary{background:#2563eb;color:#fff}
.success{background:#16a34a;color:#fff}
.danger{background:#dc2626;color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:center}
th{background:#f8fafc}

#camModal{
 display:none;position:fixed;inset:0;
 background:rgba(0,0,0,.6);z-index:999
}
#camBox{
 background:#fff;margin:40px auto;padding:14px;
 width:95%;max-width:420px;border-radius:18px
}
#scanner{height:280px;border-radius:14px;overflow:hidden}
</style>
</head>

<body>

<header>
<h2>ðŸ§¾ Market POS PRO</h2>
<nav>
<button onclick="openSec('stock')">ðŸ“¦ Stok</button>
<button onclick="openSec('sale')">ðŸ›’ Shitje</button>
</nav>
</header>

<!-- STOCK -->
<section id="stock" class="active">
<div class="card">
<h3>Shto / Edito Produkt</h3>
<input id="sn" placeholder="Emri">
<input id="sb" placeholder="Barkod">
<input id="sp" type="number" placeholder="Ã‡mimi">
<input id="ss" type="number" placeholder="Sasia">
<div>
<button class="primary" onclick="openCam('stock','environment')">ðŸ“· Kamera Mbrapa</button>
<button class="primary" onclick="openCam('stock','user')">ðŸ¤³ Kamera Para</button>
<button class="success" onclick="saveProduct()">ðŸ’¾ Ruaj</button>
</div>
</div>

<div class="card">
<h3>Stoku (LIVE)</h3>
<table>
<thead>
<tr><th>EmÃ«r</th><th>Barkod</th><th>Ã‡mim</th><th>Sasi</th></tr>
</thead>
<tbody id="stockTbl"></tbody>
</table>
</div>
</section>

<!-- SALE -->
<section id="sale">
<div class="card">
<input id="saleScan" placeholder="Scan barkod / emÃ«r / USB">
<div>
<button class="primary" onclick="manualAdd()">âž• Manual</button>
<button class="primary" onclick="openCam('sale','environment')">ðŸ“· Kamera</button>
</div>
</div>

<div class="card">
<table>
<thead>
<tr><th>Produkt</th><th>Sasi</th><th>Total</th></tr>
</thead>
<tbody id="saleTbl"></tbody>
</table>
<h3>Total: <span id="total">0</span> ALL</h3>
<input id="paid" type="number" placeholder="Klienti paguan">
<h3 id="change">Kusur: 0</h3>
<button class="success" onclick="pay()">PAGUAJ</button>
</div>
</section>

<!-- CAMERA MODAL -->
<div id="camModal">
<div id="camBox">
<h3>Scan Barcode</h3>
<div id="scanner"></div>
<button class="danger" onclick="stopCam()">Mbyll</button>
</div>
</div>

<script>
/* ðŸ”¥ FIREBASE INIT */
firebase.initializeApp({
 apiKey:"AIzaSyD_CfsHudMqShAeXzOg7z91xYE7k-13hbk",
 databaseURL:"https://market-pos-ab2e4-default-rtdb.europe-west1.firebasedatabase.app"
});
const db=firebase.database();

/* STATE */
let products={},cart=[],editing=null;
let scanTarget=null,scanLock=false;

/* NAV */
function openSec(id){
 document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

/* ðŸ”„ LIVE SYNC PRODUCTS */
db.ref("products").on("child_added",snap=>{
 products[snap.key]=snap.val();
 renderStock();
});
db.ref("products").on("child_changed",snap=>{
 products[snap.key]=snap.val();
 renderStock(); renderSale();
});

/* ðŸ“¦ STOCK */
function saveProduct(){
 if(!sn.value||!sb.value||!sp.value||!ss.value)
  return alert("PlotÃ«so tÃ« gjitha");

 if(editing){
  db.ref("products/"+editing).set({
   n:sn.value,b:sb.value,p:+sp.value,s:+ss.value
  });
  editing=null;
 }else{
  db.ref("products").push({
   n:sn.value,b:sb.value,p:+sp.value,s:+ss.value
  });
 }
 sn.value=sb.value=sp.value=ss.value="";
}

function renderStock(){
 stockTbl.innerHTML="";
 Object.entries(products).forEach(([id,p])=>{
  stockTbl.innerHTML+=`
  <tr onclick="editProd('${id}')">
   <td>${p.n}</td>
   <td>${p.b}</td>
   <td>${p.p}</td>
   <td>${p.s}</td>
  </tr>`;
 });
}
function editProd(id){
 let p=products[id];
 editing=id;
 sn.value=p.n; sb.value=p.b; sp.value=p.p; ss.value=p.s;
}

/* ðŸ›’ SALE */
function manualAdd(code){
 let v=(code||saleScan.value).toLowerCase();
 let id=Object.keys(products).find(i=>
  products[i].b===v || products[i].n.toLowerCase()===v
 );
 if(!id)return alert("Produkti nuk ekziston");
 if(products[id].s<1)return alert("Stok 0");
 let c=cart.find(x=>x.id===id);
 c?c.q++:cart.push({id,q:1});
 renderSale(); saleScan.value="";
}
saleScan.onkeydown=e=>e.key==="Enter"&&manualAdd();

function renderSale(){
 saleTbl.innerHTML="";
 let t=0;
 cart.forEach(x=>{
  let p=products[x.id];
  t+=x.q*p.p;
  saleTbl.innerHTML+=`
   <tr><td>${p.n}</td><td>${x.q}</td><td>${x.q*p.p}</td></tr>`;
 });
 total.textContent=t;
 calc();
}
function calc(){
 let d=(+paid.value||0)-total.textContent;
 change.textContent=d>=0?`Kusur: ${d}`:`MungojnÃ«: ${-d}`;
}
paid.oninput=calc;

function pay(){
 if(+paid.value<+total.textContent)
  return alert("Nuk mjafton shuma");
 cart.forEach(x=>{
  db.ref("products/"+x.id+"/s").transaction(v=>v-x.q);
 });
 cart=[];renderSale();paid.value="";change.textContent="";
}

/* ðŸ“· CAMERA */
function openCam(target,mode){
 scanTarget=target;scanLock=false;
 camModal.style.display="block";
 Quagga.init({
  inputStream:{type:"LiveStream",target:scanner,
   constraints:{facingMode:mode}},
  decoder:{readers:["ean_reader","code_128_reader"]}
 },err=>{
  if(err)return alert("HTTPS + leje kamerÃ«");
  Quagga.start();
 });
 Quagga.onDetected(d=>{
  if(scanLock)return;
  scanLock=true;
  let code=d.codeResult.code;
  if(scanTarget==="stock")sb.value=code;
  if(scanTarget==="sale")manualAdd(code);
  setTimeout(stopCam,400);
 });
}
function stopCam(){
 Quagga.stop();camModal.style.display="none";
}
</script>

</body>
</html>
