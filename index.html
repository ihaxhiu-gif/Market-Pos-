<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8">
<title>POS Market â€“ ONLINE PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#eef2f7}
header{background:#1e293b;color:#fff;padding:15px}
nav button{margin:4px;padding:10px;border:none;border-radius:10px;background:#334155;color:#fff}
section{display:none;padding:15px}
section.active{display:block}
.card{background:#fff;padding:15px;border-radius:14px;margin-bottom:12px}
input,button{padding:8px;border-radius:8px;border:1px solid #cbd5f5}
button{background:#2563eb;color:#fff;font-weight:600}
table{width:100%;border-collapse:collapse}
th,td{padding:6px;border-bottom:1px solid #ddd;text-align:center}
.admin{display:none}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6)}
.modal-content{background:#fff;margin:80px auto;padding:15px;width:95%;max-width:420px}
</style>
</head>

<body>

<header>
<h2>ðŸ›’ POS Market (ONLINE)</h2>
<nav id="menu" style="display:none">
<button onclick="openSec('stock')" class="admin">Stok</button>
<button onclick="openSec('sale')">Shitje</button>
<button onclick="openSec('bil')" class="admin">Bilanc</button>
<button onclick="logout()">Dil</button>
</nav>
</header>

<section id="login" class="active">
<div class="card">
<h3>Login</h3>
<input id="u" placeholder="user">
<input id="p" type="password">
<button onclick="login()">Hyr</button>
</div>
</section>

<section id="stock">
<div class="card admin">
<h3>Shto Produkt</h3>
<input id="pn" placeholder="Emri">
<input id="pb" placeholder="Barkodi">
<input id="pp" type="number" placeholder="Ã‡mimi">
<input id="ps" type="number" placeholder="Sasia">
<button onclick="addProduct()">âž• Shto</button>
</div>
<table id="stockTbl"></table>
</section>

<section id="sale">
<div class="card">
<input id="scan" placeholder="Barkod / EmÃ«r">
<button onclick="manualAdd()">Shto</button>
</div>
<div class="card">
<table id="saleTbl"></table>
<h3>Total: <span id="total">0</span> ALL</h3>
<input id="paid" type="number" placeholder="Klienti jep">
<h3>Kusur / MungesÃ«: <span id="change">0</span></h3>
<button onclick="pay()">Paguaj</button>
</div>
</section>

<section id="bil" class="admin">
<div class="card">
<h3>Bilanci Ditor</h3>
<p>Sistem: <b><span id="daily">0</span> ALL</b></p>
<input id="real" type="number" placeholder="Shuma reale">
<p>Diferenca: <b><span id="diff">0</span></b></p>
<button onclick="closeDay()">Mbyll DitÃ«n</button>
</div>
</section>

<script>
/* ðŸ”¥ FIREBASE CONFIG â€“ VENDOS TÃ‹ TUAT */
firebase.initializeApp({
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  databaseURL: "https://PROJECT.firebaseio.com",
  projectId: "PROJECT"
});
const db = firebase.database();

/* USERS */
const users=[{u:'admin',p:'admin',r:'admin'},{u:'kasier',p:'kasier',r:'kasier'}];
let role=null;

/* DATA */
let products={}, cart=[];
const today=new Date().toISOString().slice(0,10);

/* LIVE SYNC */
db.ref("products").on("value",s=>{
  products=s.val()||{};
  drawStock();
});
db.ref("daily/"+today).on("value",s=>{
  daily.textContent=s.val()||0;
});

/* LOGIN */
function login(){
let f=users.find(x=>x.u===u.value&&x.p===p.value);
if(!f)return;
role=f.r;
login.style.display='none';
menu.style.display='block';
document.querySelectorAll('.admin').forEach(e=>e.style.display=role==='admin'?'block':'none');
openSec('sale');
}
function logout(){location.reload();}
function openSec(id){
document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
document.getElementById(id).classList.add('active');
}

/* STOK */
function addProduct(){
db.ref("products").push({
  n:pn.value,b:pb.value,p:+pp.value,s:+ps.value
});
pn.value=pb.value=pp.value=ps.value='';
}
function drawStock(){
stockTbl.innerHTML='<tr><th>EmÃ«r</th><th>Barkod</th><th>Ã‡mim</th><th>Sasi</th></tr>';
Object.entries(products).forEach(([id,p])=>{
stockTbl.innerHTML+=`
<tr>
<td>${p.n}</td><td>${p.b}</td><td>${p.p}</td><td>${p.s}</td>
</tr>`;
});
}

/* SHITJE */
function manualAdd(){
let v=scan.value.toLowerCase();
let id=Object.keys(products).find(i=>products[i].b===v||products[i].n.toLowerCase().includes(v));
if(!id||products[id].s<1)return;
let c=cart.find(x=>x.id===id);
c?c.q++:cart.push({id,q:1});
drawCart();
scan.value='';
}
scan.onkeydown=e=>e.key==='Enter'&&manualAdd();

function drawCart(){
saleTbl.innerHTML='<tr><th>Produkt</th><th>Sasi</th><th>Tot</th></tr>';
let t=0;
cart.forEach(x=>{
let p=products[x.id];
t+=x.q*p.p;
saleTbl.innerHTML+=`<tr><td>${p.n}</td><td>${x.q}</td><td>${x.q*p.p}</td></tr>`;
});
total.textContent=t;
calc();
}
function calc(){
let d=(+paid.value||0)-total.textContent;
change.textContent=d<0?`-${Math.abs(d)}`:d;
}
paid.oninput=calc;

function pay(){
if(+paid.value<+total.textContent)return;
cart.forEach(x=>{
db.ref("products/"+x.id+"/s").transaction(v=>v-x.q);
});
db.ref("sales/"+today).push({cart,total:+total.textContent,time:Date.now()});
db.ref("daily/"+today).transaction(v=>(v||0)+ +total.textContent);
cart=[]; drawCart(); paid.value='';
}

/* BACKUP */
function closeDay(){
db.ref("backup/"+Date.now()).set({
  products,
  sales:cart,
  daily:daily.textContent
});
alert("Backup u ruajt");
}
</script>
</body>
</html>
